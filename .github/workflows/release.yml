name: Release

on:
  push:
    tags:
      - 'v*.*.*'

# Allow this workflow to create releases and upload assets using the GITHUB_TOKEN
permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup environment
        run: |
          mkdir -p dist
      - name: Create package
        run: |
          # Force PKGNAME to the tag name so package names match the tag in release
          PKGNAME="${{ github.ref_name }}" make package
      - name: Create or find GitHub Release
        id: get_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ensure GITHUB_TOKEN is defined before "set -u"
          GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"
          set -euo pipefail
          TAG=${{ github.ref_name }}
          REPO=${{ github.repository }}

          # ensure jq is available
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq >/dev/null
          fi

          # Attempt to create the release. If it already exists, fall back to fetching it.
          echo "Attempting to create release $TAG in $REPO"
          if curl -sS -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" \
                https://api.github.com/repos/${REPO}/releases -d "{\"tag_name\": \"${TAG}\", \"name\": \"${TAG}\", \"draft\": false, \"prerelease\": false}" \
                -o /tmp/release.json; then
            # check for 'id' and upload_url
            if jq -e '.id and .upload_url' /tmp/release.json >/dev/null 2>&1; then
              echo "Created release $TAG"
            fi
          fi

          # If creation failed or release already exists, try to fetch it explicitly
          if ! jq -e '.upload_url' /tmp/release.json >/dev/null 2>&1; then
            echo "Release create returned no upload_url, fetching existing release $TAG"
            curl -sS -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${REPO}/releases/tags/${TAG}" -o /tmp/release.json
          fi

          if ! jq -e '.upload_url' /tmp/release.json >/dev/null 2>&1; then
            echo "ERROR: failed to create or fetch release for tag $TAG"
            cat /tmp/release.json || true
            exit 1
          fi

          UPLOAD_URL=$(jq -r .upload_url /tmp/release.json)
          # remove the template part { ?name,label }
          UPLOAD_URL=${UPLOAD_URL%%\{*}
          echo "upload_url=$UPLOAD_URL" >> $GITHUB_OUTPUT
      - name: Upload release asset (tarball)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPLOAD_URL: ${{ steps.get_release.outputs.upload_url }}
        run: |
          set -euo pipefail
          U=${UPLOAD_URL%%\{*}
          echo "Uploading tarball to $U"
          curl -sS -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: application/gzip" --data-binary @dist/${{ github.ref_name }}-mailprobe.tar.gz "${U}?name=mailprobe-${{ github.ref_name }}.tar.gz"
      - name: Upload release asset (sha256)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPLOAD_URL: ${{ steps.get_release.outputs.upload_url }}
        run: |
          set -euo pipefail
          U=${UPLOAD_URL%%\{*}
          echo "Uploading sha256 to $U"
          curl -sS -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: text/plain" --data-binary @dist/${{ github.ref_name }}-mailprobe.sha256 "${U}?name=mailprobe-${{ github.ref_name }}.sha256"
